@model CCAF.Models.OrderHistoryViewModel
@using System.Data;
@{
    ViewBag.Title = "OrderHistory";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style type="text/css">

    input[type=text]{
        border-bottom:1px solid #ccc !important;
    }
    .for_label_styling form {
    width: 66%;
    margin-top: 7px;
    margin-bottom: -40px;
    z-index: 1;
    margin-left: 191px;
}

    .text_right {
        width: 80%;
    }

    .top-title h2 {
        margin-bottom: -13px;
    }
    .dtr-inline{
        min-height:0px!important;
    }
.ordpopup {
    position: fixed;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.3);
    z-index: 2;
    display: none;
    transition:all 0.5s ease-in-out 0s;
    -webkit-transition:all 0.5s ease-in-out 0s;
}
.ordpopup .ordpopupinner{
    background:#fff;
    width:70%;
    padding:20px 10px;
    position:absolute;
    top:40%;
    left:50%;
    border-radius:6px;
    transform:translate(-50%,-50%);
    border:1px solid #ccc;
}
.ordpopup .ordpopupinner .popupdata{
    position:relative;
    display:block;
    width:100%;
}
.ordpopup .ordpopupinner .popupdata a{
    position:absolute;
    top:-37px;
    right:-23px;
    background:#f00;
    color:#fff;
    font-size:20px;
    text-transform:uppercase;
    border-radius:30px;
    padding:4px 13px;
    box-shadow:0px 0px 3px rgba(0,0,0,0.3);
}
.for-center {
    margin-top: 40px !important;
}

    table.dataTable.no-footer{
        min-height:0 !important;
    }

    table.dataTable tbody td {
        padding: 5px 17px !important;
        vertical-align:middle !important;
    }
</style>

<div class="wrapper">

    <div class="top-title"><h2>Order History</h2></div>


    <div class="container">
        <div class="row for-row-margin for_label_styling">

            @using (Html.BeginForm("OrderHistory", "Home", FormMethod.Post, new { enctype = "multipart/form-data" }))
            {
                <div class="col-lg-2 col-md-2 col-sm-2 col-xs-12 ">
                    <p>
                        @Html.LabelFor(m => m._DateParm.FromDate)
                    </p>
                </div>
                <div class="col-lg-3 col-md-3 col-sm-3 col-xs-12">
                    @Html.TextBoxFor(m => m._DateParm.FromDate, new { @class = "flatpickr flatpickr-input active", @id = "FromDate" })
                </div>

                <div class="col-lg-2 col-md-2 col-sm-2 col-xs-12">
                    <p>@Html.LabelFor(m => m._DateParm.ToDate)</p>
                </div>
                <div class="col-lg-3 col-md-3 col-sm-3 col-xs-12">
                    @Html.TextBoxFor(m => m._DateParm.ToDate, new { @class = "flatpickr flatpickr-input active", @id = "ToDate" })
                </div>

                <div class="col-lg-2 col-md-2 col-sm-2 col-xs-12">
                    @*<div class="save_button"> <button type="submit" onclick=" return Validate();">ViewByPost</button></div>*@
                    <div class="save_button"> <button type="button" onclick="View_ButtonClick()">View</button></div>

                </div>

            }
        </div>

        @*<script>
                //$('.flatpickr').flatpickr({
                //});

            </script>*@

        <div class="row">
            <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 padding-zero ">

                <div class="">
                    <div class="order_table_bg" style="overflow-x:auto;">
                        <table id="tbl" class="table order_table for-center hover cell-border order-column amountarightalign">
                            @*table order_table order_table-right*@
                            <thead>
                                <tr>
                                <th>Sr No</th>
                                <th>Order No</th>
                                <th>Order Date</th>
                                <th>Delivery Date</th>
                                <th style="display:none">User Type</th>
                                <th>Customer</th>
                                <th>Delivery Option</th>
                                <th>Order Status   </th>
                                <th style="text-align:right">Total Amount   </th>
                                 <th>   </th>
                                </tr>
                                    @*@if (Model._LineData != null)
                                        {
                                            foreach (DataColumn col in Model._LineData.Columns)
                                            {
                                        <th>@col.ColumnName</th>
                                            }
                                        }*@
                              
                            </thead>
                            <tbody id="tbdyoh">
                                @*@if (Model._LineData != null && Model._LineData.Rows.Count > 0)
                                    {
                                        foreach (DataRow row in Model._LineData.Rows)
                                        {
                                    <tr>
                                        @foreach (DataColumn col in Model._LineData.Columns)
                                                {
                                                <td>@row[col.ColumnName]</td>
                                                }
                                    </tr>
                                        }
                                    }*@

                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <div class="footer-first">
    </div>

</div>

<div id="popupord" class="ordpopup" style="display: none;">
    <div class="ordpopupinner">
        <div class="popupdata">
            <table id="tbl" class="table order_table hover cell-border order-column">
             
                <thead>
                    <tr>
                        <th>Web Order No </th>
                        <th>Line Number </th>
                        <th>Item Id </th>
                        <th>Item Name </th>
                        <th>Qty</th>
                        <th style="text-align:right">Extended Price VIP</th>
                    </tr>
               

                </thead>
                <tbody id="tbdyohpu">
              

                </tbody>
            </table>
            <a class="" href="javascript:void(0);" onclick="dialogout()">X</a>
        </div>
    </div>
</div>


<script type="text/javascript">
 
    $(document).ready(function () {
        

        var check_in = flatpickr("#FromDate", { dateFormat: "d-M-Y" });
              
        var check_out = flatpickr("#ToDate", { dateFormat: "d-M-Y" });
     
    });

    function Validate() {
        var startDate = document.getElementById("FromDate").value;
        var endDate = document.getElementById("ToDate").value;
        if (startDate == '') {
            ShowMessage('Please Pick a "From Date"!');
            return false;
        }
        else if (endDate == '') {
            ShowMessage('Please Pick a "To Date"!');
            return false;
        }

        else if ((Date.parse(startDate) > Date.parse(endDate))) {
            ShowMessage('"To Date" should be greater than "From Date"!');
            return false;
        }
        else {
            return true;
        }
    }

    function View_ButtonClick() {
        $('#tbdyoh').html('');
      
        if (!Validate()) {
            return;
        }
        var tblStore = $('#tbdyoh');
        var fromDate = $("#FromDate").val();
        var toDate = $("#ToDate").val();
        var Parmlist = '{"FROMDATE":"' + fromDate + '","TODATE":"' + toDate + '"}';
        $.ajax({
            type: "GET",
            crossDomain: true,
            dataType: 'json',
            url: '/GenerateOrder/GetData?FunctionName=GETORDERHISTORY&objData=' + Parmlist+'&specific=2',
            success: function (response) {

                if (typeof response === 'string')
                    ShowMessage(response);
                var table = $('#tbl').DataTable();
                //clear datatable
                table.clear().draw();
                //destroy datatable
                table.destroy();
                $.each(response, function (index, val) {
                    trData = $('<tr><td data-rt-label="Sr No">' + val['Sr No'] + '</td><td data-rt-label="Order No">' + val['Order No'] + '</td><td data-rt-label="Order Date">' + val['Order Date'] + '</td><td data-rt-label="Delivery Date">' + val['Delivery Date'] + '</td><td style="display:none" data-rt-label="User Type">' + val['User Type'] + '</td><td data-rt-label="Customer">' + val['Customer'] + '</td><td data-rt-label="Delivery Option">' + val['Delivery Option'] + '</td><td id="statord" data-rt-label="Order Status">' + val['Order Status'] + '</td><td data-rt-label="Total Amount">' + val['Total Amount'].toFixed(2) + '</td><td><a onclick="dialog(\'' + val['Order No'] + '\',\'' + val['Order Type'] + '\')">View</a></td></tr>');
                  tblStore.append(trData);
                });
            },
            complete: function () {
                $('#theadao').show();

                var table = $('#tbl').DataTable({
                   // responsive: true

                         scrollCollapse: true
                    , "bDestroy": true
                  , "lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]]
                         , "language": {
                             "search": ""
                             , "sLengthMenu": "Display _MENU_ Records"
                             , "info": "Displaying _START_ to _END_ of _TOTAL_ Records"
                             , "infoEmpty": "Displaying 0 to 0 of 0 Records"
                         }
                         , columnDefs: [{
                             targets: 0,
                             className: 'dt-body-center'
                         }, {
                             targets: -3,
                             className: 'dt-body-right'
                         }]
                });
                $('.dataTables_filter input').attr("placeholder", "Search");

                table.draw();
            },
            failure: function (text) {
                ShowMessage(text.responseText);
            },
            error: function (text, xhr, ajaxOptions, thrownError) {
                debugger;
                if (xhr.status === 401) {
                    window.location.href = xhr.Data.LogOnUrl;
                    return;
                }
                var table = $('#tbl').DataTable();
                table.clear().draw();
                var message;
                if (text.responseText == 'Empty') {
                    message = 'No Records to Show in the Selected Date Range.';
                }
                else {
                    message = 'No Records to Show in the Selected Date Range.';
                }
                ShowMessage(message);
            }
        });
    }
</script>
<script>
   
    function dialog(ordno, ordtype) {
        $('#tbdyohpu').html('');
        var tblStore = $('#tbdyohpu');
        $.ajax({
            type: 'POST',
            url: '@Url.Action("PopupData", "Home")',
            data: "{'OrdNo':'" + ordno + "'}",
            datatype: 'application/json',
            contentType: 'application/json',
            success: function (data) {
                
                var Data = JSON.parse(data);
                $.each(Data, function (i, val) {
                  
                    trData = $('<tr><td ><span class="popup_before">Web Order No</span>' + val['WebOrderNo'] + '</td><td ><span class="popup_before">Line Number</span>' + val['LineNumber'] + '</td><td ><span class="popup_before">Item ID</span>' + val['ItemId'] + "</td><td ><span class='popup_before'>Item Name</span>" + val['Name'] + '</td><td ><span class="popup_before">Qty</span>' + val['OrderQty'] + '</td><td style="text-align:right"><span class="popup_before">Extended Price</span>' + val['ExtendedPriceVIP'] + '</td></tr>');
                    tblStore.append(trData); 
                });
            },
            error: function (xhr, ajaxOptions, thrownError) {
                if (xhr.status === 401) {
                    window.location.href = xhr.Data.LogOnUrl;
                    return;
                }
            }
        });

        $('.ordpopup').fadeIn();
    }
    function dialogout() {
        $('.ordpopup').fadeOut();
    }

</script>

<script>
    //alert(response);

    //var dataU = JSON.stringify(response);

    //var text = '{"data" : [{"param1":"0.00","param2":"15.00","param3":"0.00","param4":"12"},{"param1":"0.00","param2":"15.00","param3":"0.00","param4":"12"}]}';
    //var text = '{"data" : ' + dataU + '}';
    //alert(text);
    //var datan = JSON.parse(dataU);
    //alert(datan);
    //alert(datan);
    //var table = $('#tbl').DataTable();
   // table.clear();
    //$.each(response, function (index, value) {
    //    alert(JSON.parse(value));
    //    table.row.add(value);
    //});
    //table.draw();
    //return;
   // table.clear().draw();
    //table.DataTable({ data: dataU })
    //$.each(response, function (i, item) {
    //    alert(response[i]);
    //    table.row.add(item);
    //});

    //var jsdata = JSON.parse('{"data" : [{"Sr No":1,"Order No":"ORD-1819-000001","Order Date":"10 Sep 2018","Order Type":"SALEORDERTYPE",'+
    //    '"Customer":"00001 Admin","Delivery Option":"Shipment",'+
    //    '"Order Status":"Create","Total Amount":0}],"columns" : { "data": "Sr No" },{ "data": "Order No" },{ "data": "Order Date" },{ "data": "Order Type" },'+
    //    '{ "data": "Customer" },{ "data": "Delivery Option" },{ "data": "Order Status" },{ "data": "Total Amount" }');
    //var tablparm = '{"data" : ' + response + '}';
    //var departement;

    //table.row.fnAddData(jsdata);//.draw(false);
    //table.row.add(["1", "ORD-1819-000001", "10 Sep 2018", "SALEORDERTYPE", "00001", "Admin", "Shipment", "Create", "0"]).draw(false);

    //var finalDataSet = [];

    //var JSObject = $.each(response, function (index, Rowobj) {
    //    var singlerow = [];
    //    var JSObject2 = $.each(Rowobj, function (index, prop) {
    //        singlerow.push(prop);
    //        //var arr = $.makeArray(singlerow);
    //        //console.log(arr);
    //    });
    //    finalDataSet.push($.makeArray(singlerow));
    //});
    ////console.log(finalDataSet);

    //table.rows.add(finalDataSet).draw();


</script>
             